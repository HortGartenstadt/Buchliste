<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buchinventar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 20px;
      display: block;
      margin: 0 auto;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    img {
      height: 100px;
      width: auto;
      object-fit: cover;
      border-radius: 5px;
    }
    .scanner-container {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      height: 100px;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #ccc;
      z-index: 1000;
      display: none;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <h1>Buchinventar</h1>
  <button onclick="startScanner()">Scanner starten</button>
  
  <div class="scanner-container" id="scannerContainer">
    <video id="scanner"></video>
  </div>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>ISBN</th>
        <th>Titel</th>
        <th>Autor</th>
        <th>Cover</th>
        <th>Anzahl</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script>
    let scannerActive = false;
    let scanner;

    function startScanner() {
      const scannerContainer = document.getElementById('scannerContainer');
      scannerContainer.style.display = 'block';

      navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 300 },
          height: { ideal: 100 }
        }
      })
      .then(stream => {
        const video = document.getElementById('scanner');
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();

        scanner = new BarcodeDetector({ formats: ['ean-13'] });
        scanLoop(video);
      })
      .catch(error => {
        console.error('Kamera-Fehler:', error);
      });
    }

    async function scanLoop(video) {
      if (!scannerActive) return;

      try {
        const barcodes = await scanner.detect(video);
        if (barcodes.length > 0) {
          const isbn = barcodes[0].rawValue;
          handleISBN(isbn);
        }
      } catch (error) {
        console.error('Scan-Fehler:', error);
      }

      requestAnimationFrame(() => scanLoop(video));
    }

    function handleISBN(isbn) {
      if (!isbn) return;

      fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`)
        .then(response => response.json())
        .then(data => {
          if (data.totalItems > 0) {
            const book = data.items[0].volumeInfo;
            const title = book.title || "Unbekannt";
            const author = book.authors ? book.authors.join(", ") : "Unbekannt";
            const cover = book.imageLinks ? book.imageLinks.thumbnail : "";

            const table = document.getElementById('inventoryTable').getElementsByTagName('tbody')[0];
            let existingRow = [...table.rows].find(row => row.cells[0].innerText === isbn);

            if (existingRow) {
              let count = parseInt(existingRow.cells[4].innerText) || 1;
              existingRow.cells[4].innerText = count + 1;
            } else {
              const newRow = table.insertRow();
              newRow.insertCell(0).innerText = isbn;
              newRow.insertCell(1).innerText = title;
              newRow.insertCell(2).innerText = author;
              newRow.insertCell(3).innerHTML = cover ? `<img src="${cover}" alt="Cover">` : '';
              newRow.insertCell(4).innerText = 1;
            }

            saveData();
          }
        })
        .catch(error => console.error('Fehler beim Abrufen der Daten:', error));
    }

    function saveData() {
      const table = document.getElementById('inventoryTable').getElementsByTagName('tbody')[0];
      const data = [...table.rows].map(row => {
        return {
          isbn: row.cells[0].innerText,
          title: row.cells[1].innerText,
          author: row.cells[2].innerText,
          cover: row.cells[3].innerHTML,
          count: row.cells[4].innerText
        };
      });
      localStorage.setItem('bookInventory', JSON.stringify(data));
    }

    function loadData() {
      const data = JSON.parse(localStorage.getItem('bookInventory')) || [];
      const table = document.getElementById('inventoryTable').getElementsByTagName('tbody')[0];
      data.forEach(book => {
        const newRow = table.insertRow();
        newRow.insertCell(0).innerText = book.isbn;
        newRow.insertCell(1).innerText = book.title;
        newRow.insertCell(2).innerText = book.author;
        newRow.insertCell(3).innerHTML = book.cover;
        newRow.insertCell(4).innerText = book.count;
      });
    }

    window.onload = loadData;
  </script>
</body>
</html>
