<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bücher Inventar</title>
</head>
<body>
    <h1>Bücher Inventar</h1>
    
    <!-- Kamera-Zugriff für das Scannen -->
    <video id="scanner" autoplay playsinline></video>
    <button onclick="startScanner()">Scanner starten</button>
    
    <!-- Tabelle zur Anzeige der Bücher -->
    <table border="1" id="bookTable">
        <thead>
            <tr>
                <th>ISBN</th>
                <th>Titel</th>
                <th>Autor</th>
                <th>Cover</th>
                <th>Anzahl</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let video = document.getElementById('scanner');

        async function startScanner() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            
            const barcodeDetector = new BarcodeDetector({ formats: ['ean_13'] });

            // Regelmäßiges Überprüfen auf Barcode-Erkennung
            setInterval(async () => {
                const barcodes = await barcodeDetector.detect(video);
                if (barcodes.length > 0) {
                    const isbn = barcodes[0].rawValue;
                    console.log('Gefundene ISBN:', isbn);
                    fetchBookData(isbn);
                }
            }, 500);
        }

        async function fetchBookData(isbn) {
            const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
            const data = await response.json();
            
            if (data.totalItems > 0) {
                const book = data.items[0].volumeInfo;
                const title = book.title || "Unbekannt";
                const author = book.authors ? book.authors.join(", ") : "Unbekannt";
                const cover = book.imageLinks ? book.imageLinks.thumbnail : "";

                updateTable(isbn, title, author, cover);
            } else {
                updateTable(isbn, "Nicht gefunden", "Nicht gefunden", "");
            }
        }

        function updateTable(isbn, title, author, cover) {
            const table = document.getElementById('bookTable').getElementsByTagName('tbody')[0];
            const rows = table.getElementsByTagName('tr');

            // Prüfen, ob ISBN bereits vorhanden ist
            for (let row of rows) {
                if (row.cells[0].innerText === isbn) {
                    let countCell = row.cells[4];
                    countCell.innerText = parseInt(countCell.innerText) + 1;
                    return;
                }
            }

            // Neues Buch hinzufügen
            let newRow = table.insertRow();
            newRow.insertCell(0).innerText = isbn;
            newRow.insertCell(1).innerText = title;
            newRow.insertCell(2).innerText = author;
            newRow.insertCell(3).innerHTML = cover ? `<img src="${cover}" alt="Cover" style="width:50px;height:auto;">` : '';
            newRow.insertCell(4).innerText = 1;
        }
    </script>
</body>
</html>
